## Redis 学习总结(二)

**接上一篇**

### Redis主从

redis的主从复制过程是异步的，主从配置选项:

```
slaveof <masterip> <masterport>  
masterauth <master-password>   # if master is password protected.
```

此外还有一些其他选项，redis默认的配置文件中对这些选项都有很好的说明。

```
# 该选项是说在主从复制过程中，与master失去连接, 那么slave在接收客户端读请求的时候会有两种不同的表现。
# 1. 如果slave-serve-stable-data设置为yes。那么客户端仍然能够正常读取数据。但有可能读到脏数据。
# 2. 反之，设置为no。客户端请求将会得到一个"SYNC with master in progress"错误。
slave-serve-stable-data <yes|no>

# 字面意思，设置从库只读
slave-read-only yes
```

下面是Redis主从复制的完整过程:

| 步　　骤 | 主服务器操作                                                 | 从服务器操作                                                 |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1        | （等待命令进入）                                             | 连接（或者重连接）主服务器，发送`SYNC`  命令                 |
| 2        | 开始执行`BGSAVE`  ，并使用缓冲区记录`BGSAVE`  之后执行的所有写命令 | 根据配置选项来决定是继续使用现有的数据（如果有的话）来处理客户端的命令请求，还是向发送请求的客户端返回错误 |
| 3        | `BGSAVE`  执行完毕，向从服务器发送快照文件，并在发送期间继续使用缓冲区记录被执行的写命令 | 丢弃所有旧数据（如果有的话），开始载入主服务器发来的快照文件 |
| 4        | 快照文件发送完毕，开始向从服务器发送存储在缓冲区里面的写命令 | 完成对快照文件的解释操作，像往常一样开始接受命令请求         |
| 5        | 缓冲区存储的写命令发送完毕；从现在开始，每执行一个写命令，就向从服务器发送相同的写命令 | 执行主服务器发来的所有存储在缓冲区里面的写命令；并从现在开始，接收并执行主服务器传来的每个写命令 |

此外， redis也可以通过下面两个命令进行和终止主从复制：

```
SLAVEOF <host> <port>
SLAVEOF no one
```



**需要注意的一点是从服务在进行同步时， 会清空自己的所有数据，因此数据库中的原有数据会丢失， 并替换成主服务器发来的数据**。



### 更换故障主服务器

举个例子， 有masterA和slaveB, 当masterA发生故障且无法恢复的时候， 需要启动另一台masterC，作为slaveB新的master。此时应当先向slaveB发送一个**SAVE**命令, 生成一个新的快照文件。将新的快照文件发送到masterC上，启动masterC, 同时设置slaveB为masterC的从机。

**Redis Sentinel** Redis Sentinel可以监视指定的Redis主服务器及其属下的从服务器，并在主服务器下线时自动进行故障转移（failover）