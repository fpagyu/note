## Mysql -- update执行过程



一条查询语句的执行过程一般是经过连接器、分析器、优化器、执行器等功能模块， 最后到达存储引擎。



和查询流程不同的是，更新流程涉及两个重要的日志模块： redo log (其实还有undo)和 binlog。



### redo log

redo log通常是物理日志， 记录的是数据页的物理修改，而不是某一行或某几行的修改，它用来恢复提交后的物理数据页(恢复数据页， 且只能恢复到最后一次提交的位置)。

如果mysql每一次的更新操作都需要写进磁盘， 整个过程IO成本会很高。使用redo log能提升更新效率， 即WAL技术。



**WAL**

> Write-Ahead Logging
>
> 先写日志，再写磁盘

**更新记录**

> InnoDB引擎先把记录写到redo log里面， 并更新内存
>
> InnoDB会在适当的时候，比如系统空闲时， 将操作记录持久化到磁盘里

在相同的数据量下， 采用WAL的数据库系统在事务提交时，磁盘写操作只有传统的回滚日志的一半左右， 大大提高了数据库磁盘IO操作的效率， 从而提高了数据库的性能.



**redo log**

1. redo log 大小固定， 可配
2. 是InnoDB引擎的日志
3. 比如一组4个文件(编号0-3)，组成一个环形结构, 每个文件大小1G
4. 从头开始写， 写到末尾又回到开始循环写
5. write pos 是当前记录的位置， 一边写一边后移， 写到第三个文件末尾后就回到0号文件开头
6. checkpoint是当前要擦除的位置， 也是往后推移并且循环的，擦除记录前把记录更新到数据文件
7. write pos和checkpoint之间是可写部分， 用来记录新的操作
8. 如果write pos追上checkpoint， 表示没有可写位置了， 此时不能执行新的更新，需要停下来擦掉一些记录(将记录更新到磁盘), 将checkpoint向前推进。

**crash safe**

通过redo log, InnoDB保证即使数据库发生异常重启， 之前提交的记录都不会丢失，这个能力成为crash safe



### 更新过程

> mysql> UPDATE T SET c = c+1 where ID=2;

1. 执行器通过引擎取ID = 2这一行。
2. ID是主键， 引擎直接用树搜索找到这一行。
3. 如果ID=2这一行所在的数据页本来就在内存中， 就直接返回给执行器。
4. 否则，需要先从磁盘读入内存， 然后再返回。
5. 执行器将引擎返回的行数据的这个值+1， 得到新的一行数据， 再调用引擎接口写入新行
6. 引擎将这行新数据更新到内存中， 同时将这个更新操作记录到redo log里，此时redo log处于prepare状态。然后告知执行器执行完成了， 随时可以提交事务。
7. 执行器生成这个操作的binlog， 并把binlog写入磁盘
8. 执行器调用引擎的提交事务接口， 引擎把刚写入的redo log改成提交(commit)状态， 更新完成。

### binlog

binlog，即二进制日志，是一个二进制文件，记录了对数据库执行更新的所有操作，并且记录了语句发生时间、执行时长、操作数据等信息。但不记录SELECT、SHOW等查询SQL语句。

二进制日志主要用于数据恢复和主从复制，及审计操作。

max_binlog_size：日志文件大小上限，二进制日志文件后缀名会由 mysql 自动拼接数字，达到此参数设置大小则写入另一个文件，同时后缀 + 1，所以在设置 log-bin 参数时仅填写路径和文件名即可，后缀名省略



### 补充（undo log)

undo log有两个作用：提供回滚和多个行版本控制(MVCC)。

在数据修改的时候，不仅记录了redo，还记录了相对应的undo，如果因为某些原因导致事务失败或回滚了，可以借助该undo进行回滚。

undo log和redo log记录物理日志不一样，它是逻辑日志。**可以认为当delete一条记录时，undo log中会记录一条对应的insert记录，反之亦然，当update一条记录时，它记录一条对应相反的update记录。**

当执行rollback时，就可以从undo log中的逻辑记录读取到相应的内容并进行回滚。有时候应用到行版本控制的时候，也是通过undo log来实现的：当读取的某一行被其他事务锁定时，它可以从undo log中分析出该行记录以前的数据是什么，从而提供该行版本信息，让用户实现非锁定一致性读取。

undo log是采用段(segment)的方式来记录的，每个undo操作在记录的时候占用一个undo log segment。

另外，**undo log**也会产生**redo log**，因为undo log也要实现持久性保护。


**延伸阅读**
[说说MySQL中的Redo log Undo log都在干啥](https://www.cnblogs.com/xinysu/p/6555082.html)
